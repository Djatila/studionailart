<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Designer Klicia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Debug Designer Klicia</h1>
        <p>Diagn√≥stico espec√≠fico para resolver o problema da designer Klicia</p>
    </div>

    <div class="container">
        <div class="section">
            <h3>üéØ A√ß√µes de Diagn√≥stico</h3>
            <button class="button" onclick="searchKliciaDesigner()">Buscar Designer Klicia</button>
            <button class="button" onclick="listAllDesigners()">Listar Todas as Designers</button>
            <button class="button" onclick="searchKliciaAppointments()">Buscar Agendamentos da Klicia</button>
            <button class="button" onclick="checkOrphanAppointments()">Verificar Agendamentos √ìrf√£os</button>
            <button class="button danger" onclick="fixKliciaAssociations()">Corrigir Associa√ß√µes da Klicia</button>
        </div>

        <div class="section">
            <h3>üìä Resultados do Diagn√≥stico</h3>
            <div id="results"></div>
        </div>

        <div class="section">
            <h3>üìù Log de Opera√ß√µes</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://pqmjfwmbitodwtpedlle.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbWpmd21iaXRvZHd0cGVkbGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzI4NTYsImV4cCI6MjA1MDU0ODg1Nn0.9qA0nTzH-9OqFJK_oUGGWPEGGJBOWJkzILrqGDwqL-E';

        // Fun√ß√£o para fazer requisi√ß√µes ao Supabase
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation',
                ...options.headers
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                throw error;
            }
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function displayResults(content) {
            document.getElementById('results').innerHTML = content;
        }

        async function searchKliciaDesigner() {
            log('üîç Buscando designer Klicia...', 'info');
            
            try {
                // Buscar por nome exato
                const exactMatch = await supabaseRequest('nail_designers?name=eq.Klicia');
                
                // Buscar por nome similar (case insensitive)
                const similarMatch = await supabaseRequest('nail_designers?name=ilike.*klicia*');
                
                let resultsHtml = '<h4>üéØ Resultados da Busca por Klicia:</h4>';
                
                if (exactMatch.length > 0) {
                    log(`‚úÖ Encontrada designer com nome exato: ${exactMatch.length} resultado(s)`, 'success');
                    resultsHtml += '<h5>Correspond√™ncia Exata:</h5>';
                    resultsHtml += generateDesignerTable(exactMatch);
                } else {
                    log('‚ö†Ô∏è Nenhuma designer encontrada com nome exato "Klicia"', 'warning');
                }
                
                if (similarMatch.length > 0) {
                    log(`üìù Encontradas designers similares: ${similarMatch.length} resultado(s)`, 'info');
                    resultsHtml += '<h5>Correspond√™ncias Similares:</h5>';
                    resultsHtml += generateDesignerTable(similarMatch);
                } else {
                    log('‚ùå Nenhuma designer encontrada com nome similar a "Klicia"', 'error');
                }
                
                displayResults(resultsHtml);
                
            } catch (error) {
                log(`‚ùå Erro ao buscar designer Klicia: ${error.message}`, 'error');
            }
        }

        async function listAllDesigners() {
            log('üìã Listando todas as designers...', 'info');
            
            try {
                const designers = await supabaseRequest('nail_designers?select=*');
                
                log(`üìä Total de designers encontradas: ${designers.length}`, 'success');
                
                let resultsHtml = '<h4>üë• Todas as Designers:</h4>';
                resultsHtml += generateDesignerTable(designers);
                
                displayResults(resultsHtml);
                
            } catch (error) {
                log(`‚ùå Erro ao listar designers: ${error.message}`, 'error');
            }
        }

        async function searchKliciaAppointments() {
            log('üìÖ Buscando agendamentos da Klicia...', 'info');
            
            try {
                // Primeiro, encontrar o ID da designer Klicia
                const designers = await supabaseRequest('nail_designers?name=ilike.*klicia*');
                
                if (designers.length === 0) {
                    log('‚ùå Designer Klicia n√£o encontrada para buscar agendamentos', 'error');
                    displayResults('<p class="error">Designer Klicia n√£o encontrada no banco de dados.</p>');
                    return;
                }
                
                let resultsHtml = '<h4>üìÖ Agendamentos da Klicia:</h4>';
                
                for (const designer of designers) {
                    log(`üîç Buscando agendamentos para designer ID: ${designer.id} (${designer.name})`, 'info');
                    
                    const appointments = await supabaseRequest(`appointments?designer_id=eq.${designer.id}&select=*`);
                    
                    resultsHtml += `<h5>Designer: ${designer.name} (ID: ${designer.id})</h5>`;
                    
                    if (appointments.length > 0) {
                        log(`‚úÖ Encontrados ${appointments.length} agendamentos para ${designer.name}`, 'success');
                        resultsHtml += generateAppointmentTable(appointments);
                    } else {
                        log(`‚ö†Ô∏è Nenhum agendamento encontrado para ${designer.name}`, 'warning');
                        resultsHtml += '<p class="warning">Nenhum agendamento encontrado.</p>';
                    }
                }
                
                displayResults(resultsHtml);
                
            } catch (error) {
                log(`‚ùå Erro ao buscar agendamentos da Klicia: ${error.message}`, 'error');
            }
        }

        async function checkOrphanAppointments() {
            log('üîç Verificando agendamentos √≥rf√£os...', 'info');
            
            try {
                // Buscar todos os agendamentos
                const appointments = await supabaseRequest('appointments?select=*');
                log(`üìä Total de agendamentos: ${appointments.length}`, 'info');
                
                // Buscar todas as designers
                const designers = await supabaseRequest('nail_designers?select=id,name');
                const designerIds = new Set(designers.map(d => d.id));
                
                // Encontrar agendamentos √≥rf√£os
                const orphanAppointments = appointments.filter(apt => !designerIds.has(apt.designer_id));
                
                let resultsHtml = '<h4>üîç Verifica√ß√£o de Agendamentos √ìrf√£os:</h4>';
                
                if (orphanAppointments.length > 0) {
                    log(`‚ö†Ô∏è Encontrados ${orphanAppointments.length} agendamentos √≥rf√£os`, 'warning');
                    resultsHtml += '<h5 class="warning">Agendamentos √ìrf√£os (sem designer v√°lida):</h5>';
                    resultsHtml += generateAppointmentTable(orphanAppointments);
                } else {
                    log('‚úÖ Nenhum agendamento √≥rf√£o encontrado', 'success');
                    resultsHtml += '<p class="success">‚úÖ Todos os agendamentos t√™m designers v√°lidas associadas.</p>';
                }
                
                // Verificar agendamentos com designer_id null
                const nullDesignerAppointments = appointments.filter(apt => apt.designer_id === null || apt.designer_id === undefined);
                
                if (nullDesignerAppointments.length > 0) {
                    log(`‚ö†Ô∏è Encontrados ${nullDesignerAppointments.length} agendamentos com designer_id null`, 'warning');
                    resultsHtml += '<h5 class="warning">Agendamentos com designer_id null:</h5>';
                    resultsHtml += generateAppointmentTable(nullDesignerAppointments);
                }
                
                displayResults(resultsHtml);
                
            } catch (error) {
                log(`‚ùå Erro ao verificar agendamentos √≥rf√£os: ${error.message}`, 'error');
            }
        }

        async function fixKliciaAssociations() {
            log('üîß Iniciando corre√ß√£o das associa√ß√µes da Klicia...', 'warning');
            
            if (!confirm('Esta opera√ß√£o ir√° tentar corrigir as associa√ß√µes da designer Klicia. Deseja continuar?')) {
                log('‚ùå Opera√ß√£o cancelada pelo usu√°rio', 'info');
                return;
            }
            
            try {
                // Primeiro, verificar se existe uma designer Klicia
                const kliciaDesigners = await supabaseRequest('nail_designers?name=ilike.*klicia*');
                
                if (kliciaDesigners.length === 0) {
                    log('‚ùå Designer Klicia n√£o encontrada. Criando nova designer...', 'warning');
                    
                    // Criar designer Klicia
                    const newDesigner = await supabaseRequest('nail_designers', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: 'Klicia',
                            email: 'klicia@studionailart.com',
                            phone: '11999999999',
                            password: 'klicia123',
                            pix_key: 'klicia@studionailart.com',
                            is_active: true
                        })
                    });
                    
                    log(`‚úÖ Designer Klicia criada com ID: ${newDesigner[0].id}`, 'success');
                    kliciaDesigners.push(newDesigner[0]);
                }
                
                const kliciaId = kliciaDesigners[0].id;
                log(`üéØ Usando designer Klicia com ID: ${kliciaId}`, 'info');
                
                // Buscar agendamentos √≥rf√£os que podem ser da Klicia
                const allAppointments = await supabaseRequest('appointments?select=*');
                const designers = await supabaseRequest('nail_designers?select=id');
                const validDesignerIds = new Set(designers.map(d => d.id));
                
                const orphanAppointments = allAppointments.filter(apt => 
                    !validDesignerIds.has(apt.designer_id) || apt.designer_id === null
                );
                
                if (orphanAppointments.length > 0) {
                    log(`üîß Corrigindo ${orphanAppointments.length} agendamentos √≥rf√£os...`, 'info');
                    
                    for (const appointment of orphanAppointments) {
                        try {
                            await supabaseRequest(`appointments?id=eq.${appointment.id}`, {
                                method: 'PATCH',
                                body: JSON.stringify({
                                    designer_id: kliciaId
                                })
                            });
                            
                            log(`‚úÖ Agendamento ${appointment.id} associado √† Klicia`, 'success');
                        } catch (error) {
                            log(`‚ùå Erro ao corrigir agendamento ${appointment.id}: ${error.message}`, 'error');
                        }
                    }
                }
                
                log('üéâ Corre√ß√£o das associa√ß√µes conclu√≠da!', 'success');
                
                // Recarregar dados para mostrar resultado
                await searchKliciaAppointments();
                
            } catch (error) {
                log(`‚ùå Erro durante a corre√ß√£o: ${error.message}`, 'error');
            }
        }

        function generateDesignerTable(designers) {
            if (designers.length === 0) {
                return '<p class="warning">Nenhuma designer encontrada.</p>';
            }
            
            let html = '<table><thead><tr>';
            html += '<th>ID</th><th>Nome</th><th>Email</th><th>Telefone</th><th>PIX</th><th>Status</th><th>Criado em</th>';
            html += '</tr></thead><tbody>';
            
            designers.forEach(designer => {
                const status = designer.is_active ? 
                    '<span class="status-active">Ativa</span>' : 
                    '<span class="status-inactive">Inativa</span>';
                
                html += `<tr>
                    <td>${designer.id}</td>
                    <td><strong>${designer.name}</strong></td>
                    <td>${designer.email || 'N/A'}</td>
                    <td>${designer.phone || 'N/A'}</td>
                    <td>${designer.pix_key || 'N/A'}</td>
                    <td>${status}</td>
                    <td>${new Date(designer.created_at).toLocaleString()}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generateAppointmentTable(appointments) {
            if (appointments.length === 0) {
                return '<p class="warning">Nenhum agendamento encontrado.</p>';
            }
            
            let html = '<table><thead><tr>';
            html += '<th>ID</th><th>Cliente</th><th>Designer ID</th><th>Servi√ßo</th><th>Data</th><th>Hora</th><th>Status</th><th>Valor</th>';
            html += '</tr></thead><tbody>';
            
            appointments.forEach(appointment => {
                html += `<tr>
                    <td>${appointment.id}</td>
                    <td>${appointment.client_name || 'N/A'}</td>
                    <td>${appointment.designer_id || '<span class="error">NULL</span>'}</td>
                    <td>${appointment.service_name || 'N/A'}</td>
                    <td>${appointment.date || 'N/A'}</td>
                    <td>${appointment.time || 'N/A'}</td>
                    <td>${appointment.status || 'N/A'}</td>
                    <td>R$ ${appointment.price || '0,00'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug Designer Klicia iniciado', 'success');
            log('üí° Use os bot√µes acima para diagnosticar o problema da designer Klicia', 'info');
        });
    </script>
</body>
</html>