<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Teste de Sincroniza√ß√£o Entre Dispositivos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .button.success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .device-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .device-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-test {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .sync-test.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .sync-test.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .appointment-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .instructions {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Teste de Sincroniza√ß√£o Entre Dispositivos</h1>
            <p>Diagn√≥stico para verificar se agendamentos aparecem em diferentes dispositivos</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã Como usar esta ferramenta:</h3>
                <ol>
                    <li><strong>Abra esta p√°gina no computador onde o agendamento foi criado</strong></li>
                    <li>Clique em "üîç Verificar Agendamentos" para ver os dados</li>
                    <li><strong>Abra a mesma p√°gina no tablet</strong> (use o mesmo link)</li>
                    <li>Compare os resultados entre os dispositivos</li>
                    <li>Se houver diferen√ßa, use "üß™ Criar Agendamento de Teste" para testar</li>
                </ol>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="button" onclick="checkAppointments()">üîç Verificar Agendamentos</button>
                <button class="button success" onclick="createTestAppointment()">üß™ Criar Agendamento de Teste</button>
                <button class="button" onclick="checkDeviceInfo()">üì± Info do Dispositivo</button>
                <button class="button danger" onclick="clearTestData()">üóëÔ∏è Limpar Dados de Teste</button>
            </div>
            
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="supabaseCount">-</div>
                    <div class="stat-label">Agendamentos (Supabase)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="localStorageCount">-</div>
                    <div class="stat-label">Agendamentos (localStorage)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="clientAppointments">-</div>
                    <div class="stat-label">Para Cliente Teste</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="deviceType">-</div>
                    <div class="stat-label">Tipo de Dispositivo</div>
                </div>
            </div>
            
            <div class="device-info" id="deviceInfo" style="display: none;">
                <div class="device-card">
                    <h3>üñ•Ô∏è Informa√ß√µes do Dispositivo</h3>
                    <div id="deviceDetails"></div>
                </div>
                <div class="device-card">
                    <h3>üåê Informa√ß√µes do Navegador</h3>
                    <div id="browserDetails"></div>
                </div>
            </div>
            
            <div class="log" id="log">Clique em "Verificar Agendamentos" para come√ßar o diagn√≥stico...</div>
            
            <div id="appointmentsList" style="display: none;">
                <h3>üìÖ Agendamentos Encontrados:</h3>
                <div id="appointmentsContent"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://vhvxjiorcggilujjtdbr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZodnhqaW9yY2dnaWx1amp0ZGJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MzYyMzgsImV4cCI6MjA3MTExMjIzOH0.X_7h0ZadhguYIPpbiSY5sbs1DfsyUaZB59zucRM9qKU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const TEST_CLIENT_PHONE = '11999999999';
        const TEST_CLIENT_NAME = 'Cliente Teste Sync';
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function detectDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            if (isTablet) return 'Tablet';
            if (isMobile) return 'Mobile';
            return 'Desktop';
        }
        
        async function loadSupabaseAppointments() {
            try {
                log('‚òÅÔ∏è Buscando agendamentos no Supabase...');
                const { data: appointments, error } = await supabase
                    .from('appointments')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`‚ùå Erro ao buscar do Supabase: ${error.message}`);
                    return [];
                }
                
                log(`‚úÖ Supabase: ${appointments?.length || 0} agendamentos encontrados`);
                return appointments || [];
            } catch (error) {
                log(`‚ùå Erro de conex√£o com Supabase: ${error.message}`);
                return [];
            }
        }
        
        function loadLocalStorageAppointments() {
            try {
                const appointments = JSON.parse(localStorage.getItem('nail_appointments') || '[]');
                log(`üì± localStorage: ${appointments.length} agendamentos encontrados`);
                return appointments;
            } catch (error) {
                log(`‚ùå Erro ao ler localStorage: ${error.message}`);
                return [];
            }
        }
        
        function filterClientAppointments(appointments, isSupabase = false) {
            return appointments.filter(apt => {
                const phone = isSupabase ? (apt.client_phone || apt.clientPhone) : apt.clientPhone;
                return phone === TEST_CLIENT_PHONE;
            });
        }
        
        function displayAppointments(supabaseAppts, localAppts) {
            const container = document.getElementById('appointmentsContent');
            container.innerHTML = '';
            
            // Agendamentos do Supabase
            if (supabaseAppts.length > 0) {
                container.innerHTML += '<h4>‚òÅÔ∏è Agendamentos do Supabase:</h4>';
                supabaseAppts.forEach(apt => {
                    const clientName = apt.client_name || apt.clientName || 'N/A';
                    const service = apt.service_name || apt.service || 'N/A';
                    const date = apt.appointment_date || apt.date || 'N/A';
                    const time = apt.appointment_time || apt.time || 'N/A';
                    
                    container.innerHTML += `
                        <div class="appointment-item">
                            <strong>üè• ${service}</strong><br>
                            üë§ Cliente: ${clientName}<br>
                            üìÖ Data: ${date} √†s ${time}<br>
                            üì± Telefone: ${apt.client_phone || apt.clientPhone || 'N/A'}<br>
                            ‚≠ê Status: ${apt.status || 'pending'}<br>
                            üí∞ Pre√ßo: R$ ${apt.service_price || apt.price || 0}<br>
                            üÜî ID: ${apt.id}
                        </div>
                    `;
                });
            }
            
            // Agendamentos do localStorage
            if (localAppts.length > 0) {
                container.innerHTML += '<h4>üì± Agendamentos do localStorage:</h4>';
                localAppts.forEach(apt => {
                    container.innerHTML += `
                        <div class="appointment-item">
                            <strong>üè• ${apt.service || 'N/A'}</strong><br>
                            üë§ Cliente: ${apt.clientName || 'N/A'}<br>
                            üìÖ Data: ${apt.date || 'N/A'} √†s ${apt.time || 'N/A'}<br>
                            üì± Telefone: ${apt.clientPhone || 'N/A'}<br>
                            ‚≠ê Status: ${apt.status || 'pending'}<br>
                            üí∞ Pre√ßo: R$ ${apt.price || 0}<br>
                            üÜî ID: ${apt.id}
                        </div>
                    `;
                });
            }
            
            if (supabaseAppts.length === 0 && localAppts.length === 0) {
                container.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">‚ùå Nenhum agendamento encontrado para o cliente teste</p>';
            }
            
            document.getElementById('appointmentsList').style.display = 'block';
        }
        
        window.checkAppointments = async function() {
            log('üîç Iniciando verifica√ß√£o de agendamentos...');
            log(`üì± Dispositivo detectado: ${detectDeviceType()}`);
            log(`üîç Buscando agendamentos para cliente: ${TEST_CLIENT_PHONE}`);
            
            // Carregar dados
            const supabaseAppointments = await loadSupabaseAppointments();
            const localStorageAppointments = loadLocalStorageAppointments();
            
            // Filtrar para o cliente teste
            const supabaseClientAppts = filterClientAppointments(supabaseAppointments, true);
            const localClientAppts = filterClientAppointments(localStorageAppointments, false);
            
            // Atualizar estat√≠sticas
            document.getElementById('supabaseCount').textContent = supabaseAppointments.length;
            document.getElementById('localStorageCount').textContent = localStorageAppointments.length;
            document.getElementById('clientAppointments').textContent = supabaseClientAppts.length + localClientAppts.length;
            document.getElementById('deviceType').textContent = detectDeviceType();
            
            // Exibir agendamentos
            displayAppointments(supabaseClientAppts, localClientAppts);
            
            // An√°lise
            log('\nüìä AN√ÅLISE:');
            log(`‚òÅÔ∏è Total no Supabase: ${supabaseAppointments.length}`);
            log(`üì± Total no localStorage: ${localStorageAppointments.length}`);
            log(`üë§ Para cliente teste (Supabase): ${supabaseClientAppts.length}`);
            log(`üë§ Para cliente teste (localStorage): ${localClientAppts.length}`);
            
            if (supabaseClientAppts.length === 0 && localClientAppts.length === 0) {
                log('‚ö†Ô∏è PROBLEMA: Nenhum agendamento encontrado para o cliente teste!');
                log('üí° Solu√ß√£o: Crie um agendamento de teste clicando no bot√£o "Criar Agendamento de Teste"');
            } else if (supabaseClientAppts.length > 0) {
                log('‚úÖ SUCESSO: Agendamentos encontrados no Supabase - sincroniza√ß√£o funcionando!');
            } else {
                log('‚ö†Ô∏è ATEN√á√ÉO: Agendamentos apenas no localStorage - pode haver problema de sincroniza√ß√£o');
            }
            
            log('\n‚úÖ Verifica√ß√£o conclu√≠da!');
        }
        
        window.createTestAppointment = async function() {
            log('üß™ Criando agendamento de teste...');
            
            const testAppointment = {
                id: `test-${Date.now()}`,
                designer_id: 'test-designer-id',
                client_name: TEST_CLIENT_NAME,
                client_phone: TEST_CLIENT_PHONE,
                client_email: 'teste@email.com',
                service_name: 'Teste de Sincroniza√ß√£o',
                appointment_date: new Date().toISOString().split('T')[0],
                appointment_time: '14:00',
                service_price: 50,
                status: 'pending'
            };
            
            try {
                // Salvar no Supabase
                const { data, error } = await supabase
                    .from('appointments')
                    .insert([testAppointment])
                    .select();
                
                if (error) {
                    log(`‚ùå Erro ao salvar no Supabase: ${error.message}`);
                    
                    // Fallback para localStorage
                    const localAppointments = JSON.parse(localStorage.getItem('nail_appointments') || '[]');
                    localAppointments.push({
                        ...testAppointment,
                        clientName: testAppointment.client_name,
                        clientPhone: testAppointment.client_phone,
                        service: testAppointment.service_name,
                        date: testAppointment.appointment_date,
                        time: testAppointment.appointment_time,
                        price: testAppointment.service_price,
                        designerId: testAppointment.designer_id
                    });
                    localStorage.setItem('nail_appointments', JSON.stringify(localAppointments));
                    log('üì± Agendamento salvo no localStorage como fallback');
                } else {
                    log('‚úÖ Agendamento de teste criado no Supabase com sucesso!');
                    log(`üÜî ID do agendamento: ${data[0].id}`);
                }
                
                // Verificar novamente
                setTimeout(() => {
                    log('üîÑ Verificando agendamentos ap√≥s cria√ß√£o...');
                    checkAppointments();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Erro ao criar agendamento de teste: ${error.message}`);
            }
        }
        
        window.checkDeviceInfo = function() {
            const deviceDetails = document.getElementById('deviceDetails');
            const browserDetails = document.getElementById('browserDetails');
            
            // Informa√ß√µes do dispositivo
            deviceDetails.innerHTML = `
                <p><strong>Tipo:</strong> ${detectDeviceType()}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Plataforma:</strong> ${navigator.platform}</p>
                <p><strong>Idioma:</strong> ${navigator.language}</p>
                <p><strong>Touch Points:</strong> ${navigator.maxTouchPoints || 0}</p>
                <p><strong>Tela:</strong> ${screen.width}x${screen.height}</p>
                <p><strong>Viewport:</strong> ${window.innerWidth}x${window.innerHeight}</p>
            `;
            
            // Informa√ß√µes do navegador
            browserDetails.innerHTML = `
                <p><strong>Navegador:</strong> ${navigator.appName}</p>
                <p><strong>Vers√£o:</strong> ${navigator.appVersion}</p>
                <p><strong>Cookies Habilitados:</strong> ${navigator.cookieEnabled ? 'Sim' : 'N√£o'}</p>
                <p><strong>Online:</strong> ${navigator.onLine ? 'Sim' : 'N√£o'}</p>
                <p><strong>LocalStorage:</strong> ${typeof(Storage) !== 'undefined' ? 'Suportado' : 'N√£o suportado'}</p>
                <p><strong>URL Atual:</strong> ${window.location.href}</p>
                <p><strong>Timestamp:</strong> ${new Date().toLocaleString()}</p>
            `;
            
            document.getElementById('deviceInfo').style.display = 'grid';
            log('üì± Informa√ß√µes do dispositivo exibidas');
        }
        
        window.clearTestData = async function() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar todos os dados de teste?')) {
                return;
            }
            
            log('üóëÔ∏è Limpando dados de teste...');
            
            try {
                // Limpar do Supabase
                const { error } = await supabase
                    .from('appointments')
                    .delete()
                    .eq('client_phone', TEST_CLIENT_PHONE);
                
                if (error) {
                    log(`‚ùå Erro ao limpar Supabase: ${error.message}`);
                } else {
                    log('‚úÖ Dados de teste removidos do Supabase');
                }
            } catch (error) {
                log(`‚ùå Erro ao conectar com Supabase: ${error.message}`);
            }
            
            // Limpar do localStorage
            try {
                const localAppointments = JSON.parse(localStorage.getItem('nail_appointments') || '[]');
                const filteredAppointments = localAppointments.filter(apt => apt.clientPhone !== TEST_CLIENT_PHONE);
                localStorage.setItem('nail_appointments', JSON.stringify(filteredAppointments));
                log('‚úÖ Dados de teste removidos do localStorage');
            } catch (error) {
                log(`‚ùå Erro ao limpar localStorage: ${error.message}`);
            }
            
            // Verificar novamente
            setTimeout(() => {
                checkAppointments();
            }, 1000);
        }
        
        // Verificar automaticamente ao carregar a p√°gina
        window.addEventListener('load', () => {
            log('üöÄ Ferramenta de diagn√≥stico carregada');
            log(`üì± Dispositivo: ${detectDeviceType()}`);
            log('üí° Clique em "Verificar Agendamentos" para come√ßar');
        });
    </script>
</body>
</html>