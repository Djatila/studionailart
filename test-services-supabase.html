<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Integra√ß√£o Servi√ßos com Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            opacity: 0.9;
        }
        .button.secondary {
            background: #6b7280;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .service-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .service-card h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
        }
        .service-card p {
            margin: 5px 0;
            color: #6b7280;
            font-size: 14px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.services {
            background: #fce7f3;
            color: #be185d;
        }
        .badge.extras {
            background: #fef3c7;
            color: #d97706;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Integra√ß√£o Servi√ßos com Supabase</h1>
        <p>Esta ferramenta testa se os servi√ßos est√£o sendo corretamente salvos e recuperados do Supabase.</p>
        
        <div class="grid">
            <div>
                <h3>üîç Verifica√ß√µes</h3>
                <button class="button" onclick="checkSupabaseConnection()">Testar Conex√£o Supabase</button>
                <button class="button" onclick="checkLocalStorage()">Verificar localStorage</button>
                <button class="button" onclick="checkSupabaseServices()">Verificar Servi√ßos no Supabase</button>
                <button class="button" onclick="compareData()">Comparar Dados</button>
            </div>
            
            <div>
                <h3>üß™ Testes</h3>
                <button class="button" onclick="testCreateService()">Criar Servi√ßo Teste</button>
                <button class="button" onclick="testUpdateService()">Atualizar Servi√ßo Teste</button>
                <button class="button" onclick="testDeleteService()">Deletar Servi√ßo Teste</button>
                <button class="button secondary" onclick="cleanupTestData()">Limpar Dados de Teste</button>
            </div>
        </div>
        
        <div class="grid">
            <div>
                <h3>üìä Servi√ßos no localStorage</h3>
                <div id="localStorageServices"></div>
            </div>
            
            <div>
                <h3>‚òÅÔ∏è Servi√ßos no Supabase</h3>
                <div id="supabaseServices"></div>
            </div>
        </div>
        
        <div class="container">
            <h3>üìù Log de Atividades</h3>
            <button class="button secondary" onclick="clearLog()">Limpar Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        // Configura√ß√£o do Supabase
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://wnlqvqzqvqzqvqzq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InducXF2cXpxdnF6cXZxenEiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczNDU0NzIwMCwiZXhwIjoyMDUwMTIzMjAwfQ.example';
        
        // Tentar obter as credenciais do localStorage ou usar valores padr√£o
        const storedUrl = localStorage.getItem('supabase_url');
        const storedKey = localStorage.getItem('supabase_anon_key');
        
        const finalUrl = storedUrl || supabaseUrl;
        const finalKey = storedKey || supabaseKey;
        
        const supabase = createClient(finalUrl, finalKey);
        
        let testServiceId = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function checkSupabaseConnection() {
            log('üîç Testando conex√£o com Supabase...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('services')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                    log(`üí° Verifique as credenciais do Supabase`, 'warning');
                } else {
                    log('‚úÖ Conex√£o com Supabase estabelecida com sucesso!', 'success');
                }
            } catch (err) {
                log(`‚ùå Erro de conex√£o: ${err.message}`, 'error');
            }
        }
        
        async function checkLocalStorage() {
            log('üîç Verificando servi√ßos no localStorage...', 'info');
            
            const services = JSON.parse(localStorage.getItem('nail_services') || '[]');
            log(`üìä Encontrados ${services.length} servi√ßos no localStorage`, 'info');
            
            const container = document.getElementById('localStorageServices');
            if (services.length === 0) {
                container.innerHTML = '<p>Nenhum servi√ßo encontrado no localStorage</p>';
            } else {
                container.innerHTML = services.map(service => `
                    <div class="service-card">
                        <h4>${service.name} <span class="badge ${service.category}">${service.category}</span></h4>
                        <p><strong>ID:</strong> ${service.id}</p>
                        <p><strong>Designer ID:</strong> ${service.designerId}</p>
                        <p><strong>Pre√ßo:</strong> R$ ${service.price}</p>
                        <p><strong>Dura√ß√£o:</strong> ${service.duration} min</p>
                        <p><strong>Descri√ß√£o:</strong> ${service.description}</p>
                    </div>
                `).join('');
            }
        }
        
        async function checkSupabaseServices() {
            log('üîç Verificando servi√ßos no Supabase...', 'info');
            
            try {
                const { data: services, error } = await supabase
                    .from('services')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`‚ùå Erro ao buscar servi√ßos: ${error.message}`, 'error');
                    return;
                }
                
                log(`üìä Encontrados ${services.length} servi√ßos no Supabase`, 'info');
                
                const container = document.getElementById('supabaseServices');
                if (services.length === 0) {
                    container.innerHTML = '<p>Nenhum servi√ßo encontrado no Supabase</p>';
                } else {
                    container.innerHTML = services.map(service => `
                        <div class="service-card">
                            <h4>${service.name} <span class="badge ${service.category || 'services'}">${service.category || 'services'}</span></h4>
                            <p><strong>ID:</strong> ${service.id}</p>
                            <p><strong>Designer ID:</strong> ${service.designer_id}</p>
                            <p><strong>Pre√ßo:</strong> R$ ${service.price}</p>
                            <p><strong>Dura√ß√£o:</strong> ${service.duration} min</p>
                            <p><strong>Descri√ß√£o:</strong> ${service.description || 'N/A'}</p>
                            <p><strong>Criado em:</strong> ${new Date(service.created_at).toLocaleString()}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                log(`‚ùå Erro ao verificar Supabase: ${err.message}`, 'error');
            }
        }
        
        async function compareData() {
            log('üîç Comparando dados entre localStorage e Supabase...', 'info');
            
            const localServices = JSON.parse(localStorage.getItem('nail_services') || '[]');
            
            try {
                const { data: supabaseServices, error } = await supabase
                    .from('services')
                    .select('*');
                
                if (error) {
                    log(`‚ùå Erro ao buscar do Supabase: ${error.message}`, 'error');
                    return;
                }
                
                log(`üìä localStorage: ${localServices.length} servi√ßos`, 'info');
                log(`üìä Supabase: ${supabaseServices.length} servi√ßos`, 'info');
                
                // Verificar servi√ßos que est√£o no localStorage mas n√£o no Supabase
                const localIds = localServices.map(s => s.id);
                const supabaseIds = supabaseServices.map(s => s.id);
                
                const onlyInLocal = localIds.filter(id => !supabaseIds.includes(id));
                const onlyInSupabase = supabaseIds.filter(id => !localIds.includes(id));
                
                if (onlyInLocal.length > 0) {
                    log(`‚ö†Ô∏è ${onlyInLocal.length} servi√ßos existem apenas no localStorage: ${onlyInLocal.join(', ')}`, 'warning');
                }
                
                if (onlyInSupabase.length > 0) {
                    log(`‚ö†Ô∏è ${onlyInSupabase.length} servi√ßos existem apenas no Supabase: ${onlyInSupabase.join(', ')}`, 'warning');
                }
                
                if (onlyInLocal.length === 0 && onlyInSupabase.length === 0) {
                    log('‚úÖ Dados sincronizados entre localStorage e Supabase!', 'success');
                }
                
            } catch (err) {
                log(`‚ùå Erro na compara√ß√£o: ${err.message}`, 'error');
            }
        }
        
        async function testCreateService() {
            log('üß™ Testando cria√ß√£o de servi√ßo...', 'info');
            
            const testService = {
                designer_id: 'test_designer_123',
                name: 'Servi√ßo de Teste',
                price: 50.00,
                duration: 60,
                description: 'Servi√ßo criado para teste da integra√ß√£o',
                category: 'services'
            };
            
            try {
                const { data, error } = await supabase
                    .from('services')
                    .insert(testService)
                    .select()
                    .single();
                
                if (error) {
                    log(`‚ùå Erro ao criar servi√ßo: ${error.message}`, 'error');
                } else {
                    testServiceId = data.id;
                    log(`‚úÖ Servi√ßo criado com sucesso! ID: ${data.id}`, 'success');
                    await checkSupabaseServices();
                }
            } catch (err) {
                log(`‚ùå Erro na cria√ß√£o: ${err.message}`, 'error');
            }
        }
        
        async function testUpdateService() {
            if (!testServiceId) {
                log('‚ö†Ô∏è Nenhum servi√ßo de teste encontrado. Crie um primeiro.', 'warning');
                return;
            }
            
            log('üß™ Testando atualiza√ß√£o de servi√ßo...', 'info');
            
            const updates = {
                name: 'Servi√ßo de Teste - ATUALIZADO',
                price: 75.00,
                description: 'Servi√ßo atualizado para teste da integra√ß√£o'
            };
            
            try {
                const { data, error } = await supabase
                    .from('services')
                    .update(updates)
                    .eq('id', testServiceId)
                    .select()
                    .single();
                
                if (error) {
                    log(`‚ùå Erro ao atualizar servi√ßo: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Servi√ßo atualizado com sucesso!`, 'success');
                    await checkSupabaseServices();
                }
            } catch (err) {
                log(`‚ùå Erro na atualiza√ß√£o: ${err.message}`, 'error');
            }
        }
        
        async function testDeleteService() {
            if (!testServiceId) {
                log('‚ö†Ô∏è Nenhum servi√ßo de teste encontrado. Crie um primeiro.', 'warning');
                return;
            }
            
            log('üß™ Testando exclus√£o de servi√ßo...', 'info');
            
            try {
                const { error } = await supabase
                    .from('services')
                    .delete()
                    .eq('id', testServiceId);
                
                if (error) {
                    log(`‚ùå Erro ao deletar servi√ßo: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Servi√ßo deletado com sucesso!`, 'success');
                    testServiceId = null;
                    await checkSupabaseServices();
                }
            } catch (err) {
                log(`‚ùå Erro na exclus√£o: ${err.message}`, 'error');
            }
        }
        
        async function cleanupTestData() {
            log('üßπ Limpando dados de teste...', 'info');
            
            try {
                const { error } = await supabase
                    .from('services')
                    .delete()
                    .like('id', 'test_%');
                
                if (error) {
                    log(`‚ùå Erro ao limpar dados: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Dados de teste limpos com sucesso!`, 'success');
                    testServiceId = null;
                    await checkSupabaseServices();
                }
            } catch (err) {
                log(`‚ùå Erro na limpeza: ${err.message}`, 'error');
            }
        }
        
        // Expor fun√ß√µes globalmente
        window.checkSupabaseConnection = checkSupabaseConnection;
        window.checkLocalStorage = checkLocalStorage;
        window.checkSupabaseServices = checkSupabaseServices;
        window.compareData = compareData;
        window.testCreateService = testCreateService;
        window.testUpdateService = testUpdateService;
        window.testDeleteService = testDeleteService;
        window.cleanupTestData = cleanupTestData;
        window.clearLog = clearLog;
        
        // Executar verifica√ß√µes iniciais
        log('üöÄ Ferramenta de teste carregada!', 'success');
        log('üí° Clique nos bot√µes para executar os testes', 'info');
        
        // Verificar dados iniciais
        await checkLocalStorage();
        await checkSupabaseServices();
    </script>
</body>
</html>